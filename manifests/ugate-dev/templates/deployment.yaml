---
# Runs a docker-mounted dev image.
# Can build images in the node's docker.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dev
  labels:
    app: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dev
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: dev
      annotations:
        sidecar.istio.io/proxyImage: gcr.io/istio-testing/proxyv2:latest
    spec:
      terminationGracePeriodSeconds: 1
      securityContext:
        runAsUser: 1000
      containers:
        - name: ubuntu
          image: gcr.io/dmeshgate/ugate:latest
          #command: ["/usr/local/bin/run.sh"]
          #args: ["--auth", "none"]
          env:
            - name: PORT
              value: "8080"
          volumeMounts:
            - mountPath: /var/run/docker.sock
              name: docker-socket-volume
            - mountPath: /work
              name: src

            - name: podinfo
              mountPath: /etc/istio/pod

            # Istio secrets (for istio-system)
            - mountPath: /var/run/secrets/istio
              name: istiod-ca-cert
            - name: istio-token
              mountPath: /var/run/secrets/tokens
              readOnly: true
          securityContext:
            privileged: true
          ports:
            - containerPort: 8080
              name: https
              protocol: TCP

      volumes:
        - name: envcfg
          configMap:
            name: codeenv
            optional: true

        - name: docker-socket-volume
          hostPath:
            path: /var/run/docker.sock
            type: File

        - name: src
          persistentVolumeClaim:
            claimName: ugate-dev

        - name: istiod-ca-cert
          configMap:
            name: istio-ca-root-cert
            optional: true

        - name: podinfo
          downwardAPI:
            items:
              - path: "labels"
                fieldRef:
                  fieldPath: metadata.labels
              - path: "annotations"
                fieldRef:
                  fieldPath: metadata.annotations

        - name: istio-token
          projected:
            sources:
              - serviceAccountToken:
                  path: istio-token
                  expirationSeconds: 43200
                  audience: istio-ca

